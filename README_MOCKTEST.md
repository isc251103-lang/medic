# モックを利用したテスト実行方法

## 目次

1. [モック環境の説明](#モック環境の説明)
2. [テストスクリプトの実行方法](#テストスクリプトの実行方法)
3. [テストスクリプトが何をして、何を確認しているか](#テストスクリプトが何をして何を確認しているか)

## モック環境の説明

### サーバー側のモック設定

本システムでは、開発・テスト環境で実際の外部システム（電子カルテシステム、LLM API等）に接続せずに動作確認できるよう、**モックモード**を実装しています。

### モックモードの有効化

`.env`ファイルで以下の環境変数を設定することで、モックモードが有効になります：

```env
EMR_MOCK_MODE=true
JWT_SECRET=default-secret-key
LLM_API_KEY=mock-api-key
NODE_ENV=development
PORT=3000
```

**注意**: `NODE_ENV=development`の場合も自動的にモックモードが有効になります。

### モック実装の詳細

#### 1. EMRClient（電子カルテシステム）のモック

`src/modules/emr-client.ts`で実装されています。

**モックモードの判定**:
```typescript
this.mockMode = process.env.EMR_MOCK_MODE === 'true' || process.env.NODE_ENV === 'development';
```

**モックデータの動作**:

- **正常系**: 患者ID `P001`（その他の有効なID）を指定すると、以下のようなモックデータを返します：
  - 患者基本情報（氏名: 山田 太郎、生年月日: 1980-01-01等）
  - 入院情報（入院日: 2024-01-01、退院日: 2024-01-15等）
  - 診断情報（本態性高血圧症）
  - 検査結果、治療経過、処方情報等

- **異常系**: 以下の患者IDを指定すると、エラーを返します：
  - `P999`: 患者が見つからないエラー（404相当）
  - `EMR_ERROR`: 電子カルテシステムエラー（503相当）
  - `INVALID_FORMAT`: 不正なデータ形式（データ変換エラーを誘発）

**ネットワーク遅延のシミュレーション**:
- 実際のAPI呼び出しと同様の挙動を再現するため、100msの遅延をシミュレートしています。

#### 2. LLMEngine（LLM API）のモック

`src/modules/llm-engine.ts`で実装されています。

**モックモードの判定**:
```typescript
this.apiKey = process.env.LLM_API_KEY || 'mock-api-key';
if (this.apiKey === 'mock-api-key') {
  // モックレスポンスを返す
}
```

**モックデータの動作**:
- `LLM_API_KEY=mock-api-key`の場合、実際のLLM APIを呼び出さず、テンプレートベースのモックレスポンスを返します。
- 返されるレスポンスは、患者データに基づいた退院時サマリーのHTML形式のコンテンツです。

### モックモードの利点

1. **外部システムへの依存なし**: 実際の電子カルテシステムやLLM APIがなくても開発・テストが可能
2. **高速な実行**: ネットワーク通信をシミュレートするため、実際のAPI呼び出しより高速
3. **再現性**: 同じ条件で何度でもテストを実行可能
4. **エラーケースのテスト**: 様々なエラーシナリオを簡単にテスト可能

### 本番環境での注意事項

**重要**: 本番環境では、必ず`EMR_MOCK_MODE=false`に設定するか、環境変数を削除してください。モックモードが有効なまま本番環境にデプロイされると、実際の外部システムに接続されません。

## テストスクリプトの実行方法

### 前提条件

1. **サーバーの起動**: テストを実行する前に、サーバーが起動している必要があります。

```powershell
# 別のターミナルでサーバーを起動
npm run dev
```

2. **モックモードの設定**: `.env`ファイルでモックモードが有効になっていることを確認してください。

```env
EMR_MOCK_MODE=true
NODE_ENV=development
```

### 実行方法

#### 基本的な実行

```powershell
.\run-test.ps1
```

または、PowerShellの実行ポリシーによっては：

```powershell
powershell -ExecutionPolicy Bypass -File .\run-test.ps1
```

#### 実行時の注意事項

- **UTF-8エンコーディング**: スクリプト内で自動的にUTF-8エンコーディングが設定されるため、日本語の出力が正しく表示されます。
- **サーバー接続**: スクリプト実行時、サーバーが`http://localhost:3000`で起動している必要があります。

### スクリプトの構成

`run-test.ps1`は、`test-api.ps1`を呼び出すラッパースクリプトです：

```powershell
# run-test.ps1
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001 | Out-Null

& ".\test-api.ps1"
```

## テストスクリプトが何をして、何を確認しているか

### テストスクリプトの処理フロー

`test-api.ps1`は、以下の順序でAPIエンドポイントをテストします：

#### 1. トークン生成

**処理内容**:
- `npm run token`を実行してJWT認証トークンを生成
- 生成されたトークンを後続のAPIリクエストで使用

**確認項目**:
- トークンが正常に生成されること
- トークンの形式が正しいこと（Bearer形式）

#### 2. ヘルスチェック

**処理内容**:
- `GET /health`エンドポイントにリクエストを送信

**確認項目**:
- サーバーが正常に起動していること
- レスポンスが`{"status":"ok"}`であること
- HTTPステータスコードが200であること

#### 3. 患者データ取得

**処理内容**:
- `GET /api/v1/patients/P001`エンドポイントにリクエストを送信
- 認証トークンをヘッダーに含める

**確認項目**:
- 患者データが正常に取得できること
- レスポンスに以下の情報が含まれること：
  - 患者基本情報（氏名、生年月日、性別等）
  - 入院情報（入院日、退院日、診療科、主治医等）
  - 診断情報
  - 検査結果
  - 治療経過
  - 処方情報
- HTTPステータスコードが200であること

**使用するモックデータ**:
- 患者ID `P001`を使用（正常系のモックデータが返される）

#### 4. サマリー生成

**処理内容**:
- `POST /api/v1/summaries/generate`エンドポイントにリクエストを送信
- リクエストボディに以下を含める：
  - `patientId`: "P001"
  - `admissionId`: "A001"
  - `options`: テンプレートバージョン等のオプション

**確認項目**:
- サマリーが正常に生成されること
- レスポンスに以下の情報が含まれること：
  - `summaryId`: 生成されたサマリーのID
  - `status`: サマリーのステータス（"draft"）
  - `version`: サマリーのバージョン
  - `content`: 生成されたサマリーのHTMLコンテンツ
- HTTPステータスコードが200であること

**使用するモックデータ**:
- EMRClientから患者データを取得（モック）
- LLMEngineからサマリーコンテンツを生成（モック）

#### 5. サマリー取得

**処理内容**:
- `GET /api/v1/summaries/{summaryId}`エンドポイントにリクエストを送信
- 前のステップで生成されたサマリーIDを使用

**確認項目**:
- 生成されたサマリーが正常に取得できること
- レスポンスに以下の情報が含まれること：
  - `summaryId`: サマリーID
  - `version`: バージョン
  - `status`: ステータス
  - `createdAt`: 作成日時
  - `content`: サマリーのHTMLコンテンツ
- HTTPステータスコードが200であること

**表示内容**:
- サマリー内容のテキストプレビュー（HTMLタグを除去）
- 完全なHTMLコンテンツ

#### 6. エラーテスト: 存在しない患者

**処理内容**:
- `GET /api/v1/patients/P999`エンドポイントにリクエストを送信
- 存在しない患者IDを使用

**確認項目**:
- 適切なエラーレスポンスが返されること
- HTTPステータスコードが404であること
- エラーコードが`PATIENT_NOT_FOUND`であること
- エラーメッセージが適切であること

**使用するモックデータ**:
- 患者ID `P999`を使用（モックで「患者が見つからない」エラーを返す）

### テスト結果の確認

スクリプト実行後、以下のような出力が表示されます：

```
=== API動作確認スクリプト ===

1. トークンを生成中...
トークン生成完了

2. ヘルスチェック...
[OK] ヘルスチェック成功
Response: {"status":"ok"}

3. 患者データ取得 (P001)...
[OK] 患者データ取得成功
  - 患者名: 山田 太郎
  - 診療科: 内科
  - 入院ID: A001

4. サマリー生成...
[OK] サマリー生成成功
  - サマリーID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  - ステータス: draft
  - バージョン: 1

5. サマリー取得...
[OK] サマリー取得成功
  - バージョン: 1
  - ステータス: draft
  - 作成日: 2025-11-13T...

6. エラーテスト: 存在しない患者 (P999)...
[OK] 期待通りのエラーが発生しました
  - HTTPステータス: 404
  - エラーコード: PATIENT_NOT_FOUND

=== テスト完了 ===
```

### テストの目的

このテストスクリプトは、以下の目的で実行されます：

1. **API動作確認**: 各APIエンドポイントが正常に動作することを確認
2. **モック環境の検証**: モックモードが正しく機能していることを確認
3. **エラーハンドリングの確認**: 適切なエラーレスポンスが返されることを確認
4. **統合テスト**: 複数のAPIを連携して動作することを確認

### トラブルシューティング

#### サーバーに接続できない

**エラー**: `[NG] ヘルスチェック失敗`

**解決方法**:
1. サーバーが起動しているか確認: `npm run dev`
2. ポート3000が使用可能か確認
3. `.env`ファイルで`PORT`が正しく設定されているか確認

#### 認証エラー

**エラー**: `[NG] 患者データ取得失敗` (HTTPステータス: 401)

**解決方法**:
1. `.env`ファイルの`JWT_SECRET`が正しく設定されているか確認
2. トークン生成が正常に完了しているか確認

#### 患者が見つからない

**エラー**: `[NG] 患者データ取得失敗` (HTTPステータス: 404)

**解決方法**:
- 患者IDが`P001`であることを確認（モックデータでは`P001`が正常系）

## 参考資料

- [MOCK_MODE.md](docs/MOCK_MODE.md) - モックモードの詳細仕様
- [README.md](README.md) - プロジェクト全体の説明
- [TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md) - トラブルシューティングガイド
